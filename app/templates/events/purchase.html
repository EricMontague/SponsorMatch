{% extends "base.html" %}



{% block title %}Sponsormatch - {{ event.title }}{% endblock %}	
{% block page_content %}
<div id="{{ event.id }}" class="container purchase">
	<div class="page-header">
		<h2>{{ event.title }} | {{ event.start_date("%b %-dth") }} - {{ event.end_date("%-dth %Y") }} </h2>
		<p>by <a href="{{ url_for('main.user_profile', company=event.user.company) }}" target="_blank">{{ event.user.company }}</a></p>
		<p class="event-datetime">{{ event.start_date("%A, %b %-d, %Y") }} at {{ event.start_time("%-I:%M %p") }} - {{ event.end_date("%A, %b %-d, %Y") }} at {{ event.end_time("%-I:%M %p") }}</p>
	</div>
	<div class="purchase-body">
		<div class="row">
			<div class="col-md-8">
				<div class="panel panel-default">
				  	<div class="panel-heading">Order Summary</div>
				  		<!-- Table -->
					    <table class="table">
						    <thead>
						    	<tr>
						    		<th scope="col">Package Name</th>
						    		<th scope="col">Price</th>
						    		<th scope="col">Fee</th>
						    		<th scope="col">Quantity</th>
						    		<th scope="col">Subtotal</th>
						    	</tr>
						    </thead>
					    	<tbody>
					    		{% for sponsorship in sponsorships %}
						    		<tr>
						    			<td>{{ sponsorship.package.name }}</td>
						    			<td class="price">${{ sponsorship.package.price }}</td>
						    			<td>{{ "${:,.2f}".format(sponsorship.package.price | float * 0.15) }}</td>
						    			<td class="quantity">1</td>
						    			<td class="subtotal">{{ "${:,.2f}".format(sponsorship.package.price | float * 1.15) }}</td>

						    		</tr>
					    		{% endfor %}
					    		<tr>
					    			<td></td>
					    			<td></td>
					    			<td></td>
					    			<td class="font-weight-bold">Sales Tax:</td>
					    			<td id="salesTax"></td>
					    		</tr>
					    		<tr>
					    			<td></td>
					    			<td></td>
					    			<td></td>
					    			<td class="font-weight-bold">Order total:</td>
					    			<td id="orderTotal"></td>
					    		</tr>
					    	</tbody>
						 </table>
					</div>
					<form id="stripeForm" method="POST" action="{{ url }}">
						<script
					        src="https://checkout.stripe.com/checkout.js"
					        class="stripe-button"
					        data-key="{{ publishable_key }}"
					        data-description="{{ description }}"
					        data-image="https://stripe.com/img/documentation/checkout/marketplace.png"
					        data-amount="{{ amount }}"
					        data-locale="auto">
					      </script>
					</form>
				</div>
				
			
				<div class="col-md-4">
					<div class="purchase-sidebar-bottom">
						<div id="whenWhere" class="panel panel-default">
						    <div class="panel-heading">
						    	<h3 class="panel-title">When & Where</h3>
						    </div>
						    <div class="panel-body">
						    	<div class="location">
							    	<p class="font-weight-bold">{{ event.venue.name }}</p>
									<p>{{ event.venue.address }}</p>
									<p>{{ event.venue.city }}, {{ event.venue.state }} {{ event.venue.zip_code }}</p>
								</div>
								<div class="event-datetime">
									<p>{{ event.start_date("%A, %b %-d, %Y") }} at {{ event.start_time("%-I:%M %p") }} - {{ event.end_date("%A, %b %-d, %Y") }} at {{ event.end_time("%-I:%M %p") }}</p>
								</div>
						    </div>
						</div>
						<div id="organizer" class="panel panel-default">
						    <div class="panel-heading">
						        <h3 class="panel-title">Organizer</h3>
						    </div>
						    <div class="panel-body">
						     	<h4 class="company">{{ event.user.company }}</h4>
						    </div>
						    <div class="organizer-details">
						    	<!-- Turn this into an ajax POST request later -->
						    	<!-- <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#contactModal">
						     		Contact Organizer
								</button> -->
							    <a id="{{ event.user.company }}" class="view-profile" href="{{ url_for('main.user_profile', company=event.user.company) }}" target="_blank">View Organizer Profile</a>
							    
						    </div>
						    <div class="events">
						        <a id="upcomingEvents"><span class="badge">{{ event.user.num_events_hosted(EventStatus.LIVE) }}</span> upcoming events</a>
						     	<a id="pastEvents"><span class="badge">{{ event.user.num_events_hosted(SponsorshipStatus.PAST) }}</span> past events</a>
						    </div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
		


	<!-- Contact Modal -->
	<div class="modal fade" id="contactModal" tabindex="-1" role="dialog" aria-labelledby="contactModalCenterTitle" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
		    <div class="modal-content">
		        <div class="modal-header">
		            <h3 class="modal-title" id="contactTitle">Contact Organizer</h3>
		            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		                <span aria-hidden="true">&times;</span>
		            </button>
		        </div>
			    <div class="modal-body">
		      	    <form class="contact-form" method="POST" action="{{ url_for('main.event', id=event.id) }}" role="form">
		      		    {{ form.hidden_tag() }}
						{{ wtf.form_errors(form, hiddens="only") }}
						<div class="row">
						    <div class="col-md-12">
								{{ wtf.form_field(form.name) }}
							</div>
							<div class="col-md-12">
								{{ wtf.form_field(form.email) }}
							</div>
							<div class="col-md-12">
								{{ wtf.form_field(form.subject) }}
							</div>
							<div class="col-md-12">
								{{ wtf.form_field(form.message) }}
							</div>
		      			</div>
		      			<div class="modal-footer">
					        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					        {{ wtf.form_field(form.submit, button_map={"submit": "btn btn-primary"}) }}
						</div>
		      		</form>
			     </div>
		    </div>
		</div>
	</div>
</div>
	
{% endblock %}


{% block scripts %}
{{ super() }}
<script type="text/javascript">
	let regexPrice = /\d+\.\d{2}/;
	let subtotal = 0;
	let userCompany = $(".view-profile").attr("id");

	//Show the modal if the user entered invalid data
	// let formErrors = {{ form.errors | safe }};
	// if ($.isEmptyObject(formErrors) === false) {
	// 	$("#contactModal").modal("show");
	// }

	// Calculate sales tax, order total, set form action attribute and script data-amount attribute
	$(".subtotal").each(function(index) {
		subtotal += parseFloat(regexPrice.exec($(this).text()));
	});
	let calculateSalesTax = function() {
		return (subtotal * 0.08).toFixed(2);
	}
	let calculateTotal = function() {
		return (parseFloat(calculateSalesTax()) + subtotal).toFixed(2);
	}
	$("#salesTax").text(`$${calculateSalesTax()}`);
	$("#orderTotal").text(`$${calculateTotal()}`);
	
	// Delete Sponsorship objects from db if the user navigates away from the page
	$(window).on("unload", function() {
		let eventId = $(".container.purchase").attr("id");
		let success = navigator.sendBeacon(`${window.origin}/events/${eventId}/sponsorships/cancel_purchase`);
		if (success === true) {
			window.location.href = window.origin;
		} else {
			window.location.href = window.origin;
		}
		
		return false;
	});


	$("#upcomingEvents").click(function() {
		window.open(`${window.origin}/users/${userCompany}`);
	});

	$("#pastEvents").click(function() {
		window.open(`${window.origin}/users/${userCompany}?past=1`);
	});


</script>
{% endblock %}

